<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Garage Door Data Entry</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Press Start 2P', monospace; margin: 0; padding: 16px; }
    .container { max-width: 520px; margin: 0 auto; }
    .status { padding: 10px; margin-bottom: 10px; font-size: 12px; }
    .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
    .box { background: #228B22; color: #fff; border: 4px solid #fff; box-shadow: 4px 4px 0 #000; padding: 16px; margin: 12px 0; }
    .input { width: 100%; padding: 16px; border: 4px solid #000; box-shadow: inset -2px -2px 0 #666, inset 2px 2px 0 #fff, 2px 2px 0 #000; }
    .btn { width: 100%; padding: 16px; background: #ff6b6b; color: #fff; border: none; box-shadow: 4px 4px 0 #000; cursor: pointer; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .choice { padding: 12px; border: 4px solid #000; background: #fff; cursor: pointer; box-shadow: 3px 3px 0 #000; text-align: center; }
    .choice.selected { background: #4caf50; color: #fff; }
    .hidden { display: none; }
    .remove { background: #cc0000; color: #fff; border: none; padding: 8px 12px; cursor: pointer; }
  </style>
  <script>
    let doors = []; let doorIdSeq = 0;

    function status(msg, ok) {
      const el = document.getElementById('status');
      el.textContent = msg; el.className = 'status ' + (ok ? 'success' : 'error'); el.style.display = 'block';
      if (ok) setTimeout(()=> el.style.display='none', 2000);
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function initAddress() {
      const container = document.getElementById('addressContainer');
      container.innerHTML = '';
      // Base input
      const input = document.createElement('input'); input.type='text'; input.id='address'; input.className='input'; input.placeholder='Enter address...'; input.required = true;
      // Suggestions list
      const list = document.createElement('div'); list.id = 'addressSuggestions'; list.style.background = '#fff'; list.style.border = '2px solid #000'; list.style.boxShadow = '3px 3px 0 #000'; list.style.marginTop = '6px'; list.style.maxHeight = '220px'; list.style.overflowY = 'auto'; list.style.display = 'none';
      container.appendChild(input); container.appendChild(list);

      let controller = null; let lastQ = '';
      input.addEventListener('input', async () => {
        const q = input.value.trim();
        if (q.length < 3) { list.style.display='none'; list.innerHTML=''; return; }
        if (q === lastQ) return; lastQ = q;
        try {
          controller?.abort(); controller = new AbortController();
          const data = await fetchJSON(`/api/places/autocomplete?q=${encodeURIComponent(q)}&limit=8`);
          const suggestions = (data && data.data) || [];
          if (!Array.isArray(suggestions) || suggestions.length === 0) { list.style.display='none'; list.innerHTML=''; return; }
          list.innerHTML = suggestions.map(s => `<div data-id="${s.placeId}" style="padding:10px; border-bottom:1px solid #ddd; cursor:pointer;">${s.text}</div>`).join('');
          list.style.display = 'block';
        } catch (e) {
          list.style.display='none'; list.innerHTML='';
        }
      });

      list.addEventListener('click', async (e) => {
        const target = e.target; if (!(target instanceof HTMLElement)) return;
        const id = target.getAttribute('data-id'); if (!id) return;
        try {
          const data = await fetchJSON(`/api/places/details?placeId=${encodeURIComponent(id)}`);
          const d = data && data.data; if (d?.address) { input.value = d.address; status('Address selected', true); }
        } catch (e) { /* ignore */ }
        list.style.display='none'; list.innerHTML='';
      });
    }

    function renderFallback(container) {
      container.innerHTML = '';
      const input = document.createElement('input'); input.type='text'; input.id='address'; input.className='input'; input.placeholder='Enter address manually...'; input.required = true;
      container.appendChild(input);
    }

    function addDoor() {
      const id = ++doorIdSeq; doors.push({ id, size:null, custom:false, w:8, h:7 });
      const host = document.getElementById('doors');
      const wrap = document.createElement('div'); wrap.className = 'box'; wrap.id = 'door_'+id;
      wrap.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div>üö™ Door ${doors.length}</div>
          ${doors.length>1?'<button class="remove" onclick="removeDoor('+id+')">Remove</button>':''}
        </div>
        <div class="grid">
          ${['8x7','9x7','16x7','18x7','8x8','16x8'].map(s=>`<button class="choice" data-size="${s}" data-door="${id}" onclick="selectSize(${id}, '${s}', this)">${s}</button>`).join('')}
          <button class="choice" data-size="custom" data-door="${id}" onclick="selectSize(${id}, 'custom', this)">Custom</button>
        </div>
        <div id="custom_${id}" class="grid hidden" style="margin-top:8px;">
          <select id="w_${id}" class="input"></select>
          <select id="h_${id}" class="input"></select>
        </div>
      `;
      host.appendChild(wrap);
      // populate custom selects
      const wSel=document.getElementById('w_'+id), hSel=document.getElementById('h_'+id);
      for (let w=6; w<=20; w++) { const o=document.createElement('option'); o.value=w; o.textContent=w+"'"; wSel.appendChild(o); }
      ;[6,6.5,7,7.5,8,8.5,9,9.5,10].forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h+"'"; hSel.appendChild(o); });
      wSel.value=8; hSel.value=7;
    }
    function removeDoor(id) {
      doors = doors.filter(d=>d.id!==id); document.getElementById('door_'+id)?.remove();
    }
    function selectSize(id, size, btn) {
      const entry = doors.find(d=>d.id===id); if (!entry) return;
      const wrap = document.getElementById('door_'+id);
      wrap.querySelectorAll('.choice').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      if (size==='custom') { entry.custom=true; document.getElementById('custom_'+id).classList.remove('hidden'); }
      else { entry.custom=false; document.getElementById('custom_'+id).classList.add('hidden'); const [w,h]=size.split('x'); entry.w=+w; entry.h=+h; entry.size=size; }
    }

    function getAddressValue() {
      if (placeAutocomplete && placeAutocomplete.value) return placeAutocomplete.value.trim();
      const inp = document.getElementById('address'); return inp ? inp.value.trim() : '';
    }

    function submitForm(e) {
      e.preventDefault();
      const address = getAddressValue(); if (!address) { status('Please enter an address', false); return; }
      if (doors.length===0) { status('Please add at least one door', false); return; }
      for (let i=0;i<doors.length;i++) if (!doors[i].custom && !doors[i].size) { status(`Select size for Door ${i+1}`, false); return; }
      const payload = { address, doors: doors.map((d,i)=>({ doorNumber:i+1, width: d.custom? +document.getElementById('w_'+d.id).value : d.w, height: d.custom? +document.getElementById('h_'+d.id).value : d.h, sizeCategory: d.custom? 'custom' : d.size })) };
      console.log('Submitting', payload); status('Submitted successfully!', true);
      document.getElementById('form').reset(); document.getElementById('doors').innerHTML=''; doors=[]; doorIdSeq=0; addDoor();
    }

    document.addEventListener('DOMContentLoaded', ()=>{ initAddress(); addDoor(); document.getElementById('addDoor').addEventListener('click', addDoor); document.getElementById('form').addEventListener('submit', submitForm); });
  </script>
</head>
<body>
  <div class="container">
    <div id="status" class="status" style="display:none"></div>
    <div class="box">
      <h3>üìç Address</h3>
      <div id="addressContainer"></div>
    </div>
    <div class="box">
      <h3>üö™ Doors</h3>
      <div id="doors"></div>
      <button id="addDoor" class="btn" type="button">‚ûï Add Another Door</button>
    </div>
    <div class="box">
      <form id="form">
        <button class="btn" type="submit">üöÄ Submit Data</button>
      </form>
    </div>
  </div>
</body>
</html>

